<section class="map" aria-label="Mapa interactivo de comercios">
  <header class="map__header">
    <p class="map__eyebrow">Explora Castelló</p>
    <h2 class="map__title">Comercios adheridos sobre el mapa</h2>
    <p class="map__subtitle">
      Visualiza {{ filteredCount }} de {{ totalCount }} establecimientos disponibles y descubre su ubicación exacta.
    </p>
  </header>

  <div class="map__body">
    <div
      #mapContainer
      class="map__canvas"
      role="presentation"
      [attr.aria-hidden]="isLoading() || isDataLoading || hasDataError ? 'true' : 'false'"
    ></div>

    <div class="map__overlay" *ngIf="isLoading() || isDataLoading">
      <p class="map__overlay-text">Cargando mapa y ubicaciones...</p>
    </div>

    <div class="map__overlay map__overlay--error" *ngIf="hasDataError && !isDataLoading">
      <p class="map__overlay-text">
        No se ha podido cargar el mapa interactivo. Revisa tu conexión e inténtalo de nuevo en unos minutos.
      </p>
    </div>
  </div>

  <section class="map__footer" *ngIf="legend().length > 0">
    <p class="map__hint">
      Los colores representan los sectores comerciales. Usa la leyenda para resaltar categorías concretas o vuelve a
      mostrar todas las ubicaciones cuando lo necesites.
    </p>

    <div class="map__legend-controls">
      <button
        type="button"
        class="map__legend-reset"
        (click)="onLegendReset()"
        [disabled]="!activeSector()"
      >
        Mostrar todos
      </button>
    </div>

    <ul class="map__legend" aria-label="Sectores visibles en el mapa">
      <li
        class="map__legend-item"
        *ngFor="let entry of legend()"
        [class.map__legend-item--active]="isLegendEntryActive(entry.sector)"
        [class.map__legend-item--dimmed]="isLegendEntryDimmed(entry.sector)"
      >
        <button
          type="button"
          class="map__legend-button"
          (click)="onLegendToggle(entry.sector)"
          [attr.aria-pressed]="isLegendEntryActive(entry.sector)"
        >
          <span class="map__legend-color" [style.--legend-color]="entry.color"></span>
          <span class="map__legend-label">{{ entry.sector }}</span>
          <span class="map__legend-count">{{ entry.count }}</span>
        </button>
      </li>
    </ul>
  </section>

  <p class="map__hint map__hint--empty" *ngIf="legend().length === 0 && !isDataLoading && !hasDataError">
    No hay comercios que coincidan con los filtros seleccionados. Ajusta la búsqueda para ver nuevas ubicaciones.
  </p>
</section>
