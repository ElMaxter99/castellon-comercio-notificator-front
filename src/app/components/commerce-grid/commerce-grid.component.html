<section class="page">
  <header class="page__hero">
    <p class="page__eyebrow">Abonem Castelló</p>
    <h1 class="page__title">Comercios adheridos al programa</h1>
    <p class="page__subtitle">
      Consulta y filtra los establecimientos que participan en la campaña de dinamización comercial de
      Castelló de la Plana.
    </p>
  </header>

  <section class="notice" aria-label="Información sobre el proyecto">
    <h2 class="notice__title">Proyecto independiente sin ánimo de lucro</h2>
    <p class="notice__body">
      Esta aplicación es una iniciativa personal sin relación con el Ayuntamiento de Castelló ni con CONFECOMERÇ.
      Los datos mostrados proceden de fuentes públicas del programa “Abonem Castelló”
      <a class="notice__link" href="https://bonoscastellodelaplana.es/establecimientos-adheridos-al-programa"
        target="_blank" rel="noreferrer noopener">
        (bonoscastellodelaplana.es)
      </a>
      y se ofrecen únicamente con fines informativos y de divulgación, sin ningún propósito comercial.
    </p>
  </section>

  <form class="filters" [formGroup]="filters" (ngSubmit)="onSubmit()">
    <header class="filters__header">
      <div>
        <p class="filters__eyebrow">Personaliza la búsqueda</p>
        <h2 class="filters__title">Filtra los comercios disponibles</h2>
      </div>
      <p class="filters__helper">
        Combina los campos para encontrar establecimientos concretos o descubre nuevas zonas explorando el mapa.
      </p>
    </header>

    <div class="filters__grid">
      <div class="filters__group filters__group--wide">
        <label class="filters__label" for="filter-name">Nombre del establecimiento</label>
        <input
          id="filter-name"
          type="text"
          formControlName="name"
          placeholder="Introduce el nombre del establecimiento"
          autocomplete="off"
        />
      </div>

      <div class="filters__group filters__group--sector" #sectorDropdownRef>
        <label class="filters__label" id="filter-sector-label">Sector del establecimiento</label>
        <button
          type="button"
          class="filters__select-trigger"
          aria-haspopup="listbox"
          [attr.aria-expanded]="isSectorDropdownOpen()"
          [attr.aria-labelledby]="'filter-sector-label'"
          (click)="onToggleSectorDropdown($event)"
        >
          <span
            class="filters__select-value"
            [class.filters__select-value--placeholder]="!filters.controls.sectorQuery.value"
          >
            {{ filters.controls.sectorQuery.value || 'Selecciona un sector' }}
          </span>
          <span class="filters__select-icon" aria-hidden="true"></span>
        </button>

        <div class="filters__select-panel" *ngIf="isSectorDropdownOpen()" role="dialog" aria-modal="false">
          <div class="filters__select-search">
            <input
              #sectorSearchInputRef
              type="text"
              [value]="sectorSearchTerm()"
              (input)="onSectorSearch($any($event.target).value)"
              placeholder="Buscar sector"
              autocomplete="off"
              role="searchbox"
            />
            <button
              type="button"
              class="filters__select-clear"
              *ngIf="filters.controls.sectorQuery.value"
              (click)="onClearSector($event)"
            >
              Limpiar
            </button>
          </div>

          <div class="filters__select-options" role="listbox" [attr.aria-activedescendant]="null">
            <button
              type="button"
              class="filters__select-option"
              *ngFor="let sector of filteredSectors(); trackBy: trackBySector"
              [class.filters__select-option--active]="filters.controls.sectorQuery.value === sector"
              (click)="onSelectSector(sector)"
              role="option"
            >
              {{ sector }}
            </button>
            <p class="filters__select-empty" *ngIf="filteredSectors().length === 0">
              No se han encontrado sectores que coincidan con la búsqueda.
            </p>
          </div>
        </div>
      </div>

      <div class="filters__group">
        <label class="filters__label" for="filter-address">Calle o dirección</label>
        <input
          id="filter-address"
          type="text"
          formControlName="address"
          placeholder="Busca por dirección o calle"
          autocomplete="off"
        />
      </div>
    </div>

    <footer class="filters__footer">
      <button type="button" class="filters__button filters__button--ghost" (click)="onResetFilters()">
        Limpiar búsqueda
      </button>
      <button type="submit" class="filters__button">Aplicar filtros</button>
    </footer>
  </form>

  <app-commerce-map
    class="page__map"
    [legendSource]="baseFilteredCommerces()"
    [commerces]="filteredCommerces()"
    [selectedSector]="filterValue().sectorQuery"
    [totalCount]="commerces().length"
    [filteredCount]="filteredCommerces().length"
    [isDataLoading]="isLoading()"
    [hasDataError]="hasError()"
    (sectorFilterChange)="onSectorFilterFromMap($event)"
  >
  </app-commerce-map>

  <div class="state" *ngIf="isLoading()">
    <p>Cargando comercios...</p>
  </div>

  <div class="state state--error" *ngIf="hasError() && !isLoading()">
    <p>
      Ha ocurrido un error al recuperar los comercios. Vuelve a intentarlo en unos instantes.
    </p>
  </div>

  <section class="grid" *ngIf="!isLoading() && !hasError()">
    <header class="grid__header">
      <div>
        <h2 class="grid__title">
          {{ filteredCommerces().length }} comercios encontrados
          <span class="grid__title-suffix">de {{ commerces().length }} disponibles</span>
        </h2>
        <p class="grid__description">
          Ajusta los filtros para acotar la búsqueda o explora el mapa para localizar comercios cercanos.
        </p>
      </div>

      <div class="grid__controls" aria-label="Opciones de visualización y paginación">
        <div class="grid__view" role="group" aria-label="Cambiar el modo de visualización">
          <span class="grid__view-label">Vista</span>
          <div class="grid__view-buttons">
            <button
              type="button"
              class="grid__view-button"
              [class.grid__view-button--active]="isViewModeActive('grid')"
              (click)="setViewMode('grid')"
            >
              Cuadrícula
            </button>
            <button
              type="button"
              class="grid__view-button"
              [class.grid__view-button--active]="isViewModeActive('list')"
              (click)="setViewMode('list')"
            >
              Lista
            </button>
          </div>
        </div>

        <label class="grid__page-size" for="page-size">Mostrar
          <select
            id="page-size"
            [value]="pageSize()"
            (change)="onPageSizeSelect($event)"
          >
            <option *ngFor="let option of pageSizeOptions" [value]="option">{{ option }}</option>
          </select>
          por página
        </label>
      </div>
    </header>

    <p class="grid__empty" *ngIf="filteredCommerces().length === 0">
      No se han encontrado comercios que coincidan con los filtros aplicados.
    </p>

    <ng-container *ngIf="filteredCommerces().length > 0">
      <div class="grid__list" [class.grid__list--list]="isViewModeActive('list')">
        <app-commerce-card
          *ngFor="let commerce of pagedCommerces(); trackBy: trackByCommerce"
          [commerce]="commerce"
          [viewMode]="viewMode()"
        >
        </app-commerce-card>
      </div>

      <nav class="grid__pagination" aria-label="Paginación de resultados" *ngIf="totalPages() > 1">
        <div class="grid__page-actions">
          <button
            type="button"
            class="grid__page-button"
            (click)="goToFirstPage()"
            [disabled]="currentPage() === 1"
          >
            Primera
          </button>
          <button
            type="button"
            class="grid__page-button"
            (click)="goToPreviousPage()"
            [disabled]="currentPage() === 1"
          >
            Anterior
          </button>
        </div>

        <ul class="grid__page-list">
          <li
            *ngFor="let item of paginationItems(); let index = index; trackBy: trackByPaginationItem"
            class="grid__page-item"
          >
            <ng-container *ngIf="item.kind === 'page'; else paginationEllipsis">
              <button
                type="button"
                class="grid__page-number"
                [class.grid__page-number--active]="currentPage() === item.value"
                [attr.aria-current]="currentPage() === item.value ? 'page' : null"
                (click)="changePage(item.value)"
              >
                {{ item.value }}
              </button>
            </ng-container>
            <ng-template #paginationEllipsis>
              <span class="grid__page-ellipsis" aria-hidden="true">…</span>
            </ng-template>
          </li>
        </ul>

        <div class="grid__page-actions">
          <button
            type="button"
            class="grid__page-button"
            (click)="goToNextPage()"
            [disabled]="currentPage() === totalPages()"
          >
            Siguiente
          </button>
          <button
            type="button"
            class="grid__page-button"
            (click)="goToLastPage()"
            [disabled]="currentPage() === totalPages()"
          >
            Última
          </button>
        </div>
      </nav>
    </ng-container>
  </section>
</section>
