<section class="page">
  <header class="page__hero">
    <p class="page__eyebrow">Abonem Castelló</p>
    <h1 class="page__title">Comercios adheridos al programa</h1>
    <p class="page__subtitle">
      Consulta y filtra los establecimientos que participan en la campaña de dinamización comercial de
      Castelló de la Plana.
    </p>
  </header>

  <section class="notice" aria-label="Información sobre el proyecto">
    <h2 class="notice__title">Proyecto independiente sin ánimo de lucro</h2>
    <p class="notice__body">
      Esta aplicación es una iniciativa personal sin relación con el Ayuntamiento de Castelló ni con CONFECOMERÇ.
      Los datos mostrados proceden de fuentes públicas del programa “Abonem Castelló”
      <a class="notice__link" href="https://bonoscastellodelaplana.es/establecimientos-adheridos-al-programa"
        target="_blank" rel="noreferrer noopener">
        (bonoscastellodelaplana.es)
      </a>
      y se ofrecen únicamente con fines informativos y de divulgación, sin ningún propósito comercial.
    </p>
  </section>

  <form class="filters" [formGroup]="filters" (ngSubmit)="onSubmit()">
    <div class="filters__group">
      <label class="filters__label" for="filter-name">Nombre del establecimiento</label>
      <input id="filter-name" type="text" formControlName="name" placeholder="Introduce el nombre del establecimiento"
        autocomplete="off" />
    </div>

    <div class="filters__group filters__group--sector" #sectorDropdownRef>
      <label class="filters__label" id="filter-sector-label">Sector del establecimiento</label>
      <button type="button" class="filters__select-trigger" aria-haspopup="listbox"
        [attr.aria-expanded]="isSectorDropdownOpen()" [attr.aria-labelledby]="'filter-sector-label'"
        (click)="onToggleSectorDropdown($event)">
        <span class="filters__select-value"
          [class.filters__select-value--placeholder]="!filters.controls.sectorQuery.value">
          {{ filters.controls.sectorQuery.value || 'Selecciona un sector' }}
        </span>
        <span class="filters__select-icon" aria-hidden="true"></span>
      </button>

      <div class="filters__select-panel" *ngIf="isSectorDropdownOpen()" role="dialog" aria-modal="false">
        <div class="filters__select-search">
          <input #sectorSearchInputRef type="text" [value]="sectorSearchTerm()"
            (input)="onSectorSearch($any($event.target).value)" placeholder="Buscar sector" autocomplete="off"
            role="searchbox" />
          <button type="button" class="filters__select-clear" *ngIf="filters.controls.sectorQuery.value"
            (click)="onClearSector($event)">
            Limpiar
          </button>
        </div>

        <div class="filters__select-options" role="listbox" [attr.aria-activedescendant]="null">
          <button type="button" class="filters__select-option"
            *ngFor="let sector of filteredSectors(); trackBy: trackBySector"
            [class.filters__select-option--active]="filters.controls.sectorQuery.value === sector"
            (click)="onSelectSector(sector)" role="option">
            {{ sector }}
          </button>
          <p class="filters__select-empty" *ngIf="filteredSectors().length === 0">
            No se han encontrado sectores que coincidan con la búsqueda.
          </p>
        </div>
      </div>
    </div>

    <div class="filters__group">
      <label class="filters__label" for="filter-address">Calle o dirección</label>
      <input id="filter-address" type="text" formControlName="address" placeholder="Busca por dirección o calle"
        autocomplete="off" />
    </div>

    <div class="filters__actions">
      <button type="button" class="filters__button filters__button--ghost" (click)="onResetFilters()">
        Limpiar
      </button>
      <button type="submit" class="filters__button">Filtrar</button>
    </div>
  </form>

  <app-commerce-map class="page__map" [commerces]="filteredCommerces()" [totalCount]="commerces().length"
    [filteredCount]="filteredCommerces().length" [isDataLoading]="isLoading()" [hasDataError]="hasError()">
  </app-commerce-map>

  <div class="state" *ngIf="isLoading()">
    <p>Cargando comercios...</p>
  </div>

  <div class="state state--error" *ngIf="hasError() && !isLoading()">
    <p>
      Ha ocurrido un error al recuperar los comercios. Vuelve a intentarlo en unos instantes.
    </p>
  </div>

  <section class="grid" *ngIf="!isLoading() && !hasError()">
    <header class="grid__header">
      <h2 class="grid__title">
        {{ filteredCommerces().length }} comercios encontrados
        <span class="grid__title-suffix">de {{ commerces().length }} disponibles</span>
      </h2>
      <p class="grid__description">
        Ajusta los filtros para acotar la búsqueda o explora el mapa para localizar comercios cercanos.
      </p>
    </header>

    <p class="grid__empty" *ngIf="filteredCommerces().length === 0">
      No se han encontrado comercios que coincidan con los filtros aplicados.
    </p>

    <ng-container *ngIf="filteredCommerces().length > 0">
      <div class="grid__list">
        <app-commerce-card *ngFor="let commerce of pagedCommerces(); trackBy: trackByCommerce" [commerce]="commerce">
        </app-commerce-card>
      </div>

      <nav class="grid__pagination" aria-label="Paginación de resultados" *ngIf="totalPages() > 1">
        <button type="button" class="grid__page-button" (click)="goToPreviousPage()" [disabled]="currentPage() === 1">
          Anterior
        </button>

        <ul class="grid__page-list">
          <li *ngFor="let page of pages(); trackBy: trackByPage" class="grid__page-item">
            <button type="button" class="grid__page-number" [class.grid__page-number--active]="currentPage() === page"
              (click)="changePage(page)">
              {{ page }}
            </button>
          </li>
        </ul>

        <button type="button" class="grid__page-button" (click)="goToNextPage()"
          [disabled]="currentPage() === totalPages()">
          Siguiente
        </button>
      </nav>
    </ng-container>
  </section>
</section>
